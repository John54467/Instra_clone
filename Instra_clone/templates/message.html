
{% extends 'base.html' %}
{% load static %}
{% block content %}
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

	<style>
		body{margin-top:20px;}

.chat-online {
    color: #34ce57
}

.chat-offline {
    color: #e4606d
}

.chat-messages {
    display: flex;
    flex-direction: column;
    max-height: 800px;
    overflow-y: scroll
}

.chat-message-left,
.chat-message-right {
    display: flex;
    flex-shrink: 0
}

.chat-message-left {
    margin-right: auto
}

.chat-message-right {
    flex-direction: row-reverse;
    margin-left: auto
}
.py-3 {
    padding-top: 1rem!important;
    padding-bottom: 1rem!important;
}
.px-4 {
    padding-right: 1.5rem!important;
    padding-left: 1.5rem!important;
}
.flex-grow-0 {
    flex-grow: 0!important;
}
.border-top {
    border-top: 1px solid #dee2e6!important;
}
	</style>

		<!-- Small stub to avoid console race: queue createChatSocket calls until real function is defined -->
		<script>
			if (!window.createChatSocket) {
				window.__pendingCreateChatSocketCalls = window.__pendingCreateChatSocketCalls || [];
				window.createChatSocket = function() {
					window.__pendingCreateChatSocketCalls.push(arguments);
					console.warn('createChatSocket queued until page scripts run');
				};
			}
		</script>
<main class="content">
    <div class="container p-0">

		<h1 class="h3 mb-3">Messages</h1>

		<div class="card">
			<div class="row g-0">
				<div class="col-12 col-lg-4 col-xl-3 border-right">

					<div class="px-4 d-none d-md-block">
						<div class="d-flex align-items-center">
							<div class="flex-grow-1">
								<a href="#" class="btn btn-success mt-4 mb-4">New Message</a>
							</div>
						</div>
					</div>
					{% for message in messages %}
					<a href="{% url 'directs' message.user.username %}" class="list-group-item list-group-item-action border-0 {% if active_direct == message.user.username %}active{% endif %}">
						<div class="badge bg-success float-right"></div>
						<div class="d-flex align-items-start pb-2">
							
								<img src="{{ message.user.profile.image.url }}" class="rounded-circle mr-1" alt="img" width="40" height="40">
							
							<div class="flex-grow-1 ml-6">
								<b>{{message.user.profile.first_name}} {{message.user.profile.last_name}}</b>
								<div class="small"><span class="fas fa-circle chat-online"></span> @{{message.user.username}}</div>
							</div>
						</div>
					</a>
					{% endfor %}

					<hr class="d-block d-lg-none mt-1 mb-0">
				</div>
				<div class="col-12 col-lg-8 col-xl-9">
					<div class="py-2 px-4 border-bottom d-none d-lg-block">
						<div class="d-flex align-items-center py-1">
							<!-- <div class="position-relative">
								<img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
							</div>
							<div class="flex-grow-1 pl-3">
								<strong>Sharon Lessman</strong>
								<div class="text-muted small"><em>Typing...</em></div>
							</div> -->
							<div>
								<button class="btn btn-primary btn-lg mr-1 px-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-phone feather-lg"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></button>
								<button class="btn btn-info btn-lg mr-1 px-3 d-none d-md-inline-block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video feather-lg"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
								<button class="btn btn-light border btn-lg px-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal feather-lg"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button>
							</div>
						</div>
					</div>

					<div class="position-relative">
						<div id="chat-box" class="chat-messages p-4">

									{% for direct in directs %}
										{% if direct.sender == request.user %}
											<div class="chat-message-right pb-2">
												<div>
													<a href=""><img src="{{ direct.sender.profile.image.url }}" class="rounded-circle mr-1" alt="img" width="40" height="40"></a>
													<div class="text-muted small text-nowrap mt-2" style="font-size:10px; color: rgba(180, 180, 180, 0);"><p style="font-size:10px; color: black;">{{direct.date|date:"d M, Y"}}</p></div>

												</div>
												<div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
													<!-- <div class="font-weight-bold mb-1">Sharon Lessman</div> -->
													{{direct.body}}
												</div>
											</div>
										{% else %}
											<div class="chat-message-left pb-2">
												<div>
													<a href=""><img src="{{ direct.sender.profile.image.url }}" class="rounded-circle mr-1" alt="img" width="40" height="40"></a>
													<div class="text-muted small text-nowrap mt-2" style="font-size:10px; color: rgba(180, 180, 180, 0);"><p style="font-size:10px; color: black;">{{direct.date|date:"d M, Y"}}</p></div>

												</div>
												<div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
													<!-- <div class="font-weight-bold mb-1">Sharon Lessman</div> -->
													{{direct.body}}
												</div>
											</div>
										{% endif %}
									{% endfor %}
							

						</div>
					</div>

						<!-- scroll-to-bottom button -->
						<button id="scroll-to-bottom" aria-label="Scroll to latest" title="Scroll to latest" style="display:none; position:absolute; right:18px; bottom:90px; z-index:50; border-radius:50%; width:44px; height:44px; padding:0;">&#8595;<span id="scroll-unread" style="display:none;position:absolute;top:-6px;right:-6px;background:#dc3545;color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;display:flex;align-items:center;justify-content:center">0</span></button>

						<div class="flex-grow-0 py-3 px-4 border-top composer">
							<form id="message-form" method="POST" action="#">
								{% csrf_token %}
								<div class="input-group">
									<input type="hidden" name="to_user" id="to_user_input" value="{{active_direct}}">
									<input id="message-input" name="body" type="text" class="form-control" placeholder="Type your message" autocomplete="off">
									<button id="send-btn" class="btn btn-primary" type="submit">Send</button>
								</div>
							</form>
							
						</div>

				</div>
			</div>
		</div>
	</div>
</main>
	<!-- Load jQuery first, then Popper (required by Bootstrap 4), then Bootstrap JS -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
{% endblock content %}

<script>
</script>
<script>
    // Replace client behaviour with the user's requested simpler WS client
    (function(){
        function readJsonId(id){ const el=document.getElementById(id); if(!el) return null; try{return JSON.parse(el.textContent);}catch(e){return null;} }
        const id = readJsonId('json-username');
        const message_username = readJsonId('json-message-username');
        const receiver = readJsonId('json-username-receiver');

        // fallback to inputs if the JSON nodes are not present
        const userId = id || (document.getElementById('to_user_input') && document.getElementById('to_user_input').value) || '';
        const msgUser = message_username || "{{ request.user.username|escapejs }}";
        const recvUser = receiver || "{{ other_user.username|default:''|escapejs }}";

		// Determine which username to put into the path. prefer explicit input value
		const pathUser = (userId && String(userId).trim()) || (recvUser && String(recvUser).trim());
		if (!pathUser) {
			console.warn('No recipient username found; skipping WebSocket connection to avoid empty path.');
			return;
		}

		const socketUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/direct/' + encodeURIComponent(pathUser) + '/';
		const socket = new WebSocket(socketUrl);

		socket.onopen = function(e){ console.log('CONNECTION ESTABLISHED to', socketUrl); };
		socket.onclose = function(e){ console.log('CONNECTION LOST', e); };
		socket.onerror = function(e){ console.log('ERROR OCCURRED', e); };

        socket.onmessage = function(e){
            try{
                const data = JSON.parse(e.data);
                const chatBody = document.querySelector('#chat-body');
                if (!chatBody) return;
                if (data.username == msgUser){
                    chatBody.innerHTML += `<tr><td><p class="bg-success p-2 mt-2 mr-5 shadow-sm text-white float-right rounded">${escapeHtml(data.message)}</p></td></tr>`;
                } else {
                    chatBody.innerHTML += `<tr><td><p class="bg-primary p-2 mt-2 mr-5 shadow-sm text-white float-left rounded">${escapeHtml(data.message)}</p></td></tr>`;
                }
                // scroll to bottom
                const chatBox = document.getElementById('chat-box'); if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            }catch(err){ console.error('WS onmessage parse error', err); }
        };

        // send on button click
        const submitBtn = document.querySelector('#chat-message-submit') || document.querySelector('#send-btn');
        const message_input = document.querySelector('#message_input') || document.querySelector('#message-input');
        if (submitBtn){
            submitBtn.addEventListener('click', function(e){ e.preventDefault(); const message = (message_input && message_input.value) || ''; if(!message) return; socket.send(JSON.stringify({ message: message, username: msgUser, receiver: recvUser })); if(message_input) message_input.value = ''; });
        }

        if (message_input){
            // make sure we have a DOM element if someone accidentally passed JSON node instead
            if (message_input.tagName === undefined){
                // it's JSON parsed earlier, ignore
            } else {
                message_input.addEventListener('keyup', function(event){
                    if (event.key === 'Enter'){
                        event.preventDefault();
                        const message = (message_input.value || '').trim();
                        if (message !== ''){
                            socket.send(JSON.stringify({ message: message, username: msgUser, receiver: recvUser }));
                            message_input.value = '';
                        }
                    }
                });
            }
        }

        // small helper to avoid XSS when injecting messages
        function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; }); }

    })();
</script>
	